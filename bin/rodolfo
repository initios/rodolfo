#!/usr/bin/env ruby

root_path = File.dirname __dir__

require 'json'
require 'slop'
require File.join(root_path, 'lib', 'rodolfo.rb')

opts = Slop.parse do |o|
  o.string '-t', '--template', 'template name'
  o.on '--skip-validation', 'skip json schema validation'
  o.on '--version', 'print the version' do
    STDOUT.write Rodolfo::VERSION
    exit 0
  end
end

unless opts[:template]
  puts opts
  exit 1
end

json_data = $stdin.tty? ? {} : $stdin.read
data = JSON.parse(json_data, symbolize_names: true)
package = Rodolfo::Package.new opts[:template], data

unless opts.skip_validation? || package.valid?
  STDOUT.write JSON.dump(package.validation_errors)
  exit 2
end

STDOUT.write package.make
exit 0
