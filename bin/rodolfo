#!/usr/bin/env ruby

root_path = File.dirname __dir__

require 'json'
require 'slop'
require File.join(root_path, 'lib', 'rodolfo')

opts = Slop.parse do |o|
  o.string '-p', '--package', 'package name'
  o.on '--skip-validation', 'skip json schema validation'
  o.on '--version', 'print the version' do
    require File.join(root_path, 'lib', 'meta')
    STDOUT.write Rodolfo::VERSION
    exit 0
  end
end

unless opts[:package]
  puts opts
  exit 1
end

json_data = $stdin.tty? ? {} : $stdin.read
data = JSON.parse(json_data, symbolize_names: true)
package = Rodolfo::Package.new opts[:package], data

unless opts.skip_validation? || package.valid?
  STDOUT.write JSON.dump(package.validation_errors)
  exit 2
end

STDOUT.write package.make
exit 0
