#!/usr/bin/env ruby

root_path = File.dirname __dir__

require 'json'
require 'slop'
require File.join(root_path, 'lib', 'rodolfo.rb')

opts = Slop.parse do |o|
  o.string '-t', '--template', 'template name'
  o.string '-o', '--output', 'output pdf (optional, you can use stdout instead)'
  o.on '--schema', 'print the json schema'
  o.on '--version', 'print the version' do
    STDOUT.write Rodolfo::VERSION
    exit 0
  end
end

unless opts[:template]
  puts opts
  exit 1
end

package = Rodolfo::Package.new(opts[:template])

if opts[:schema]
  STDOUT.write package.schema
  exit 0
end

json_data = $stdin.tty? ? nil : $stdin.read
data = JSON.parse(json_data, symbolize_names: true)
bytes = package.make data

if opts[:output]
  open(opts[:output], 'wb') { |f| f.puts bytes }
else
  STDOUT.write bytes
end
